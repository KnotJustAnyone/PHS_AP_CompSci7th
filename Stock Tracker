import json
import os
import requests
import csv
from io import StringIO
from datetime import datetime

PORTFOLIO_FILE = "portfolio.json"
HISTORY_FILE = "history.csv"


def get_stock_price(ticker):
    symbol = ticker.lower() + ".us"
    url = f"https://stooq.com/q/l/?s={symbol}&f=sd2t2ohlcv&h&e=csv"

    response = requests.get(url)
    response.raise_for_status()

    reader = csv.DictReader(StringIO(response.text))
    rows = list(reader)

    if len(rows) == 0 or rows[0]["Close"] == "N/A":
        return None

    stock = rows[0]
    return {
        "ticker": ticker,
        "date": stock["Date"],
        "close": float(stock["Close"]),
        "volume": int(stock["Volume"])
    }


def log_portfolio_value(total_value):
    file_exists = os.path.exists(HISTORY_FILE)

    with open(HISTORY_FILE, "a", newline="") as f:
        writer = csv.writer(f)

        if not file_exists:
            writer.writerow(["timestamp", "total_value"])

        timestamp = datetime.now().isoformat(timespec="seconds")
        writer.writerow([timestamp, f"{total_value:.2f}"])


def view_growth():
    if not os.path.exists(HISTORY_FILE):
        print("No growth history yet. Use option 4 (Portfolio) to log snapshots.")
        return

    with open(HISTORY_FILE, "r", newline="") as f:
        reader = csv.DictReader(f)
        rows = list(reader)

    if len(rows) == 0:
        print("History file is empty.")
        return

    # Parse values
    values = []
    times = []
    for r in rows:
        try:
            times.append(r["timestamp"])
            values.append(float(r["total_value"]))
        except (KeyError, ValueError, TypeError):
            pass

    if len(values) == 0:
        print("No valid snapshots found in history.")
        return

    first_time = times[0]
    first_value = values[0]

    last_time = times[-1]
    last_value = values[-1]

    dollar_change = last_value - first_value

    if first_value == 0:
        percent_growth = None
    else:
        percent_growth = (dollar_change / first_value) * 100

    print("\n--- Growth Over Time ---")
    print(f"First:  {first_time} | ${first_value:,.2f}")
    print(f"Latest: {last_time} | ${last_value:,.2f}")
    print(f"Change: ${dollar_change:,.2f}")

    if percent_growth is None:
        print("Percent Growth: N/A (first value was $0.00)")
    else:
        print(f"Percent Growth: {percent_growth:.2f}%")

    # Change since previous snapshot (if possible)
    if len(values) >= 2:
        prev_time = times[-2]
        prev_value = values[-2]
        change_since_prev = last_value - prev_value

        if prev_value == 0:
            pct_since_prev = None
        else:
            pct_since_prev = (change_since_prev / prev_value) * 100

        print("\n--- Since Previous Snapshot ---")
        print(f"Previous: {prev_time} | ${prev_value:,.2f}")
        print(f"Change:   ${change_since_prev:,.2f}")
        if pct_since_prev is None:
            print("Percent:  N/A (previous value was $0.00)")
        else:
            print(f"Percent:  {pct_since_prev:.2f}%")


# load portfolio
portfolio = {}
if os.path.exists(PORTFOLIO_FILE):
    with open(PORTFOLIO_FILE, "r") as f:
        portfolio = json.load(f)


# main loop
while True:
    print("\n1 View price  2 Buy  3 Remove  4 Portfolio  5 Quit  6 View Growth")
    choice = input("Choose: ")

    if choice == "5":
        break

    if choice == "1":
        ticker = input("Enter ticker: ").upper()
        stock_data = get_stock_price(ticker)

        if stock_data is None:
            print("Invalid ticker or data unavailable.")
        else:
            print("\nTicker:", stock_data["ticker"])
            print("Date:", stock_data["date"])
            print("Closing Price: $", stock_data["close"])
            print("Volume:", stock_data["volume"])

    elif choice == "2":
        ticker = input("Buy ticker: ").upper()
        stock_data = get_stock_price(ticker)

        if stock_data is None:
            print("Invalid ticker.")
        else:
            shares = float(input("How many shares? "))
            portfolio[ticker] = portfolio.get(ticker, 0) + shares
            print(f"{ticker}: {portfolio[ticker]} shares")

    elif choice == "3":
        ticker = input("Remove ticker: ").upper()

        if ticker not in portfolio:
            print("Stock not in portfolio.")
        else:
            shares = float(input("Shares to remove: "))
            portfolio[ticker] -= shares

            if portfolio[ticker] <= 0:
                del portfolio[ticker]
                print(f"{ticker} removed.")
            else:
                print(f"{ticker}: {portfolio[ticker]} shares")

    elif choice == "4":
        if not portfolio:
            print("Portfolio empty.")
        else:
            print("\n--- Portfolio Summary ---")
            portfolio_total = 0
            for ticker, shares in portfolio.items():
                stock_data = get_stock_price(ticker)
                if stock_data:
                    value = stock_data["close"] * shares
                    portfolio_total += value
                    print(f"- {ticker}: {shares} shares | Value: ${value:,.2f}")
                else:
                    print(f"- {ticker}: {shares} shares | (Price unavailable)")

            print(f"\nTotal Portfolio Value: ${portfolio_total:,.2f}")

            # log growth snapshot
            log_portfolio_value(portfolio_total)

    elif choice == "6":
        view_growth()

    # save portfolio
    with open(PORTFOLIO_FILE, "w") as f:
        json.dump(portfolio, f, indent=2)

print("Goodbye")
