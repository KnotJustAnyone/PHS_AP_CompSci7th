import json
import os
import requests
import csv
from io import StringIO

PORTFOLIO_FILE = "portfolio.json"

def get_stock_price(ticker):
    """
    Fetch stock price data from Stooq (public, no API key)
    """
    symbol = ticker.lower() + ".us"
    url = f"https://stooq.com/q/l/?s={symbol}&f=sd2t2ohlcv&h&e=csv"

    # Requesting data
    response = requests.get(url)
    response.raise_for_status()

    # Parsing data
    reader = csv.DictReader(StringIO(response.text))
    rows = list(reader)

    # Checking if data is available
    if len(rows) == 0 or rows[0]["Close"] == "N/A":
        return None

    stock = rows[0]

    # Returning data structured
    return {
        "ticker": ticker,
        "date": stock["Date"],
        "close": float(stock["Close"]),
        "volume": int(stock["Volume"])
    }

# STEP 3: save ticker + shares to a text file
def save_stock(ticker, shares):
    with open("stocks.txt", "a") as file:
        file.write(f"{ticker},{shares}\n")

# STEP 3: load ticker + shares when program starts
def load_saved_stocks():
    if not os.path.exists("stocks.txt"):
        return []

    stocks = []
    with open("stocks.txt", "r") as file:
        for line in file:
            if line.strip():
                parts = line.strip().split(",")
                if len(parts) == 2:
                    ticker, shares = parts
                    stocks.append((ticker, float(shares)))
                else:
                    # Fallback for old/corrupted format: assume 0 shares or ignore
                    stocks.append((parts[0], 0.0))
    return stocks

# Load saved stocks (STEP 3)
searched_stocks = load_saved_stocks()

# Main loop
while True:
    ticker = input("Enter a stock ticker (or type QUIT): ").upper()

    if ticker == "QUIT":
        break

    stock_data = get_stock_price(ticker)

    if stock_data is None:
        print("Invalid ticker or data unavailable.")
    else:
        shares = float(input("How many shares? "))
        total_value = stock_data["close"] * shares

        print("\nTicker:", stock_data["ticker"])
        print("Date:", stock_data["date"])
        print("Closing Price: $", stock_data["close"])
        print(f"Total Value: ${total_value:,.2f}")
        print("Volume:", stock_data["volume"])

        searched_stocks.append((ticker, shares))
        save_stock(ticker, shares)

print("\nStocks saved (with shares):")
for stock, shares in searched_stocks:
    print(f"- {stock}: {shares} shares")
